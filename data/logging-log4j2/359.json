{"files": 1, "singleLine": false, "nb_error": 0, "failing_tests": ["Log4jServletContainerInitializerTest.testOnStartupFailedDueToPreExistingFilter:111", "Unexpected method call ServletContext.log(\"Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.\"):", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.tearDown:51", "Expectation failure on verify:", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "ServletContext.log(<any>): expected: 1, actual: 0", "ServletContext.getAttribute(\"org.apache.logging.log4j.core.web.Log4jWebInitializer.INSTANCE\"): expected: 1, actual: 0", "ServletContext.addListener(capture(Nothing captured yet)): expected: 1, actual: 0", "ServletContext.addFilter(\"log4jServletFilter\", capture(Nothing captured yet)): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.testOnStartupWithServletVersion2_x:60", "Unexpected method call ServletContext.log(\"Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.\"):", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.tearDown:51", "Expectation failure on verify:", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.testOnStartupWithServletVersion3_x:86", "Unexpected method call ServletContext.log(\"Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.\"):", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.tearDown:51", "Expectation failure on verify:", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "ServletContext.log(<any>): expected: 1, actual: 0", "ServletContext.getAttribute(\"org.apache.logging.log4j.core.web.Log4jWebInitializer.INSTANCE\"): expected: 1, actual: 0", "ServletContext.addListener(capture(Nothing captured yet)): expected: 1, actual: 0", "ServletContext.addFilter(\"log4jServletFilter\", capture(Nothing captured yet)): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.testOnStartupFailedDueToInitializerFailure:135", "Unexpected method call ServletContext.log(\"Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.\"):", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "Log4jServletContainerInitializerTest.tearDown:51", "Expectation failure on verify:", "ServletContext.getMajorVersion(): expected: 1, actual: 0", "ServletContext.log(<any>): expected: 1, actual: 0", "ServletContext.getAttribute(\"org.apache.logging.log4j.core.web.Log4jWebInitializer.INSTANCE\"): expected: 1, actual: 0"], "nb_test": 419, "patch": "diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/web/Log4jServletContainerInitializer.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/web/Log4jServletContainerInitializer.java\nindex 6add448..50b0820 100644\n--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/web/Log4jServletContainerInitializer.java\n+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/web/Log4jServletContainerInitializer.java\n@@ -23,24 +23,33 @@ import javax.servlet.FilterRegistration;\n import javax.servlet.ServletContainerInitializer;\n import javax.servlet.ServletContext;\n import javax.servlet.ServletException;\n+import javax.servlet.UnavailableException;\n \n /**\n  * In a Servlet 3.0 or newer environment, this initializer is responsible for starting up Log4j logging before anything\n- * else happens in application initialization.\n+ * else happens in application initialization. For consistency across all containers, if the effective Servlet major\n+ * version of the application is less than 3.0, this initializer does nothing.\n  */\n public class Log4jServletContainerInitializer implements ServletContainerInitializer {\n \n     @Override\n     public void onStartup(final Set<Class<?>> classes, final ServletContext servletContext) throws ServletException {\n-        servletContext.log(\"Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.\");\n+        if (servletContext.getMajorVersion() > 2) {\n+            servletContext.log(\"Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.\");\n \n-        final Log4jWebInitializer initializer = Log4jWebInitializerImpl.getLog4jWebInitializer(servletContext);\n-        initializer.initialize();\n-        initializer.setLoggerContext(); // the application is just now starting to start up\n+            final Log4jWebInitializer initializer = Log4jWebInitializerImpl.getLog4jWebInitializer(servletContext);\n+            initializer.initialize();\n+            initializer.setLoggerContext(); // the application is just now starting to start up\n \n-        servletContext.addListener(new Log4jServletContextListener());\n+            servletContext.addListener(new Log4jServletContextListener());\n \n-        final FilterRegistration.Dynamic filter = servletContext.addFilter(\"log4jServletFilter\", new Log4jServletFilter());\n-        filter.addMappingForUrlPatterns(EnumSet.allOf(DispatcherType.class), false, \"/*\");\n+            final FilterRegistration.Dynamic filter =\n+                    servletContext.addFilter(\"log4jServletFilter\", new Log4jServletFilter());\n+            if (filter == null) {\n+                throw new UnavailableException(\"In a Servlet 3.0+ application, you must not define a \" +\n+                        \"log4jServletFilter in web.xml. Log4j 2 defines this for you automatically.\");\n+            }\n+            filter.addMappingForUrlPatterns(EnumSet.allOf(DispatcherType.class), false, \"/*\");\n+        }\n     }\n }\n", "project": "logging-log4j2", "linesAdd": 17, "nb_skipped": 5, "fix_commit": "296ea4a5", "nb_failure": 8, "id": "359", "linesRem": 8}