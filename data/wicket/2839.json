{"nb_failure": 2, "nb_error": 0, "failing_tests": ["testWriteStream(org.apache.wicket.request.resource.WriteCallbackTest)", "testLastModifiedForResourceInJar(org.apache.wicket.util.resource.UrlResourceStreamTest)"], "patch": "diff --git a/wicket/src/main/java/org/apache/wicket/request/resource/AbstractResource.java b/wicket/src/main/java/org/apache/wicket/request/resource/AbstractResource.java\nindex 1f6f526..00358a06 100644\n--- a/wicket/src/main/java/org/apache/wicket/request/resource/AbstractResource.java\n+++ b/wicket/src/main/java/org/apache/wicket/request/resource/AbstractResource.java\n@@ -463,7 +463,7 @@ public abstract class AbstractResource implements IResource\n \t\t\t\t@Override\n \t\t\t\tpublic void write(byte[] b, int off, int len) throws IOException\n \t\t\t\t{\n-\t\t\t\t\tif (off == 0 || len == b.length)\n+\t\t\t\t\tif (off == 0 && len == b.length)\n \t\t\t\t\t{\n \t\t\t\t\t\twrite(b);\n \t\t\t\t\t}\ndiff --git a/wicket/src/main/java/org/apache/wicket/util/resource/UrlResourceStream.java b/wicket/src/main/java/org/apache/wicket/util/resource/UrlResourceStream.java\nindex 8a0cef7..02a144b 100644\n--- a/wicket/src/main/java/org/apache/wicket/util/resource/UrlResourceStream.java\n+++ b/wicket/src/main/java/org/apache/wicket/util/resource/UrlResourceStream.java\n@@ -193,26 +193,26 @@ public class UrlResourceStream extends AbstractResourceStream\n \t@Override\n \tpublic Time lastModifiedTime()\n \t{\n-\t\tif (file != null)\n+\t\ttry\n \t\t{\n-\t\t\t// in case the file has been removed by now\n-\t\t\tif (file.exists() == false)\n+\t\t\tif (file != null)\n \t\t\t{\n-\t\t\t\treturn null;\n-\t\t\t}\n+\t\t\t\t// in case the file has been removed by now\n+\t\t\t\tif (file.exists() == false)\n+\t\t\t\t{\n+\t\t\t\t\treturn null;\n+\t\t\t\t}\n \n-\t\t\tlong lastModified = file.lastModified();\n+\t\t\t\tlong lastModified = file.lastModified();\n \n-\t\t\t// if last modified changed update content length and last modified date\n-\t\t\tif (lastModified != this.lastModified)\n-\t\t\t{\n-\t\t\t\tthis.lastModified = lastModified;\n-\t\t\t\tcontentLength = (int)file.length();\n+\t\t\t\t// if last modified changed update content length and last modified date\n+\t\t\t\tif (lastModified != this.lastModified)\n+\t\t\t\t{\n+\t\t\t\t\tthis.lastModified = lastModified;\n+\t\t\t\t\tsetContentLength();\n+\t\t\t\t}\n \t\t\t}\n-\t\t}\n-\t\telse\n-\t\t{\n-\t\t\ttry\n+\t\t\telse\n \t\t\t{\n \t\t\t\tlong lastModified = Connections.getLastModified(url);\n \n@@ -221,31 +221,35 @@ public class UrlResourceStream extends AbstractResourceStream\n \t\t\t\t{\n \t\t\t\t\tthis.lastModified = lastModified;\n \n-\t\t\t\t\tURLConnection connection = url.openConnection();\n-\t\t\t\t\tcontentLength = connection.getContentLength();\n-\t\t\t\t\tConnections.close(connection);\n+\t\t\t\t\tsetContentLength();\n \t\t\t\t}\n \t\t\t}\n-\t\t\tcatch (IOException e)\n+\t\t\treturn Time.milliseconds(lastModified);\n+\t\t}\n+\t\tcatch (IOException e)\n+\t\t{\n+\t\t\tif (url.toString().indexOf(\".jar!\") >= 0)\n \t\t\t{\n-\t\t\t\tif (url.toString().indexOf(\".jar!\") >= 0)\n+\t\t\t\tif (log.isDebugEnabled())\n \t\t\t\t{\n-\t\t\t\t\tif (log.isDebugEnabled())\n-\t\t\t\t\t{\n-\t\t\t\t\t\tlog.debug(\"getLastModified for \" + url + \" failed: \" + e.getMessage());\n-\t\t\t\t\t}\n+\t\t\t\t\tlog.debug(\"getLastModified for \" + url + \" failed: \" + e.getMessage());\n \t\t\t\t}\n-\t\t\t\telse\n-\t\t\t\t{\n-\t\t\t\t\tlog.warn(\"getLastModified for \" + url + \" failed: \" + e.getMessage());\n-\t\t\t\t}\n-\n-\t\t\t\t// allow modification watcher to detect the problem\n-\t\t\t\treturn null;\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\tlog.warn(\"getLastModified for \" + url + \" failed: \" + e.getMessage());\n \t\t\t}\n \n+\t\t\t// allow modification watcher to detect the problem\n+\t\t\treturn null;\n \t\t}\n-\t\treturn Time.milliseconds(lastModified);\n+\t}\n+\n+\tprivate void setContentLength() throws IOException\n+\t{\n+\t\tURLConnection connection = url.openConnection();\n+\t\tcontentLength = connection.getContentLength();\n+\t\tConnections.close(connection);\n \t}\n \n \t/**\n", "nb_test": 880, "nb_skipped": 1, "fix_commit": "15477252", "id": "2839"}