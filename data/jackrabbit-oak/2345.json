{"files": 1, "singleLine": false, "nb_error": 0, "failing_tests": ["inactiveClusterId(org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreTest)"], "nb_test": 2029, "patch": "diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java\nindex 95a82d5..29a363e 100644\n--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java\n+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java\n@@ -1532,6 +1532,13 @@ public final class DocumentNodeStore\n             Revision last = lastKnownRevision.get(machineId);\n             if (last == null || r.compareRevisionTime(last) > 0) {\n                 lastKnownRevision.put(machineId, r);\n+                // OAK-2345\n+                // only consider as external change if\n+                // - the revision changed for the machineId\n+                // or\n+                // - the revision is within the time frame we remember revisions\n+                if (last != null\n+                        || r.getTimestamp() > revisionPurgeMillis())\n                 externalChanges.put(r, otherSeen);\n             }\n         }\n@@ -1562,7 +1569,17 @@ public final class DocumentNodeStore\n                 backgroundOperationLock.writeLock().unlock();\n             }\n         }\n-        revisionComparator.purge(Revision.getCurrentTimestamp() - REMEMBER_REVISION_ORDER_MILLIS);\n+        revisionComparator.purge(revisionPurgeMillis());\n+    }\n+\n+    /**\n+     * Returns the time in milliseconds when revisions can be purged from the\n+     * revision comparator.\n+     *\n+     * @return time in milliseconds.\n+     */\n+    private static long revisionPurgeMillis() {\n+        return Revision.getCurrentTimestamp() - REMEMBER_REVISION_ORDER_MILLIS;\n     }\n \n     private void backgroundSplit() {\n", "project": "jackrabbit-oak", "linesAdd": 18, "nb_skipped": 9, "fix_commit": "a0dc4c89", "nb_failure": 1, "id": "2345", "linesRem": 1}