{
  "files": 2, 
  "singleLine": false, 
  "nb_error": 0, 
  "failing_tests": [
    "emptyIndex(org.apache.jackrabbit.oak.plugins.index.lucene.LucenePropertyIndexTest): (..)"
  ], 
  "nb_test": 301, 
  "patch": "diff --git a/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditor.java b/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditor.java\nindex 5277652..e13e7ef 100644\n--- a/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditor.java\n+++ b/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditor.java\n@@ -38,6 +38,7 @@ import org.apache.jackrabbit.oak.api.PropertyState;\n import org.apache.jackrabbit.oak.api.Type;\n import org.apache.jackrabbit.oak.plugins.index.IndexEditor;\n import org.apache.jackrabbit.oak.plugins.index.IndexUpdateCallback;\n+import org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState;\n import org.apache.jackrabbit.oak.plugins.nodetype.TypePredicate;\n import org.apache.jackrabbit.oak.spi.commit.Editor;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n@@ -122,6 +123,9 @@ public class LuceneIndexEditor implements IndexEditor {\n     @Override\n     public void enter(NodeState before, NodeState after)\n             throws CommitFailedException {\n+        if (EmptyNodeState.MISSING_NODE == before && parent == null){\n+            context.enableReindexMode();\n+        }\n     }\n \n     @Override\ndiff --git a/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorContext.java b/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorContext.java\nindex 686db73..a25bc41 100644\n--- a/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorContext.java\n+++ b/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorContext.java\n@@ -101,6 +101,8 @@ public class LuceneIndexEditorContext {\n \n     private final IndexUpdateCallback updateCallback;\n \n+    private boolean reindex;\n+\n     LuceneIndexEditorContext(NodeBuilder definition, Analyzer analyzer, IndexUpdateCallback updateCallback) {\n         this.definitionBuilder = definition;\n         this.definition = new IndexDefinition(definitionBuilder);\n@@ -132,6 +134,14 @@ public class LuceneIndexEditorContext {\n      * close writer if it's not null\n      */\n     void closeWriter() throws IOException {\n+        //If reindex or fresh index and write is null on close\n+        //it indicates that the index is empty. In such a case trigger\n+        //creation of write such that an empty Lucene index state is persisted\n+        //in directory\n+        if (reindex && writer == null){\n+            getWriter();\n+        }\n+\n         if (writer != null) {\n             writer.close();\n \n@@ -144,6 +154,10 @@ public class LuceneIndexEditorContext {\n         }\n     }\n \n+    public void enableReindexMode(){\n+        reindex = true;\n+    }\n+\n     public long incIndexedNodes() {\n         indexedNodes++;\n         return indexedNodes;\n", 
  "project": "jackrabbit-oak", 
  "linesAdd": 18, 
  "nb_skipped": 1, 
  "fix_commit": "29d3d8f1", 
  "nb_failure": 1, 
  "id": "2235", 
  "linesRem": 0
}