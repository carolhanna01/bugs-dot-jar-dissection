{"files": 2, "singleLine": false, "nb_error": 0, "failing_tests": ["rebaseWithFailedMerge[0](org.apache.jackrabbit.oak.kernel.NodeStoreTest)", "rebaseWithFailedMerge[1](org.apache.jackrabbit.oak.kernel.NodeStoreTest)", "rebaseWithFailedMerge[2](org.apache.jackrabbit.oak.kernel.NodeStoreTest)"], "nb_test": 1530, "patch": "diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java\nindex c7da536..440e47b 100644\n--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java\n+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java\n@@ -145,7 +145,19 @@ class KernelRootBuilder extends MemoryNodeBuilder implements FastCopyMove {\n      */\n     NodeState merge(CommitHook hook, CommitInfo info) throws CommitFailedException {\n         purge();\n-        branch.merge(hook, info);\n+        boolean success = false;\n+        try {\n+            branch.merge(hook, info);\n+            success = true;\n+        } finally {\n+            if (!success) {\n+                // need to adjust base and head of this builder\n+                // in case branch.merge() did a rebase and then\n+                // a commit hook failed the merge\n+                super.reset(branch.getHead());\n+                this.base = branch.getBase();\n+            }\n+        }\n         return reset();\n     }\n \ndiff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoRootBuilder.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoRootBuilder.java\nindex f4ac698..268f3df 100644\n--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoRootBuilder.java\n+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoRootBuilder.java\n@@ -142,7 +142,19 @@ class MongoRootBuilder extends MemoryNodeBuilder {\n      */\n     NodeState merge(CommitHook hook, CommitInfo info) throws CommitFailedException {\n         purge();\n-        branch.merge(hook, info);\n+        boolean success = false;\n+        try {\n+            branch.merge(hook, info);\n+            success = true;\n+        } finally {\n+            if (!success) {\n+                // need to adjust base and head of this builder\n+                // in case branch.merge() did a rebase and then\n+                // a commit hook failed the merge\n+                super.reset(branch.getHead());\n+                this.base = branch.getBase();\n+            }\n+        }\n         return reset();\n     }\n \n", "project": "jackrabbit-oak", "linesAdd": 26, "nb_skipped": 6, "fix_commit": "64045631", "nb_failure": 3, "id": "1320", "linesRem": 2}